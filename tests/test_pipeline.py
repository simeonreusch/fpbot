#!/usr/bin/env python
# coding: utf-8

import logging, os
import unittest
import ztfquery
import pandas as pd

from fpbot.pipeline import ForcedPhotometryPipeline, FORCEPHOTODATA


class TestPipeline(unittest.TestCase):
    def setUp(self):
        logging.getLogger("fpbot.pipeline").setLevel(logging.DEBUG)
        logging.getLogger("fpbot.observations").setLevel(logging.DEBUG)

        self.logger = logging.getLogger(__name__)
        self.logger.setLevel(logging.DEBUG)

    def test_pipeline(self):
        self.logger.info("\n\n Testing FP Pipeline \n\n")
        from fpbot.pipeline import ForcedPhotometryPipeline

        jdmin = 2459761.50000

        ztf_id = "ZTF19aatubsj"

        pl = ForcedPhotometryPipeline(
            file_or_name=ztf_id,
            jdmin=jdmin,
            jdmax=jdmin + 3,
            ampel=True,
        )

        pl.download()
        pl.psffit()
        pl.plot()

        df_filepath = os.path.join(FORCEPHOTODATA, ztf_id + ".csv")
        plot_filepath = os.path.join(
            FORCEPHOTODATA, "plots", "images", ztf_id + "_SNT_5.0.png"
        )

        self.assertTrue(os.path.isfile(plot_filepath))

        true_df_string = "       sigma  sigma.err        ampl   ampl.err         fval       chi2   chi2dof                                 filename  exptime  humidity filter        obsmjd  ccdid  amp_id  gain  readnoi  darkcur      magzp      magzpunc  magzprms  clrcoeff  clrcounc  zpclrcov      zpmed      zpavg  zprmsall  clrmed  clravg    clrrms  qid  rcid  seeing  airmass  nmatches  maglim  status  infobits  filterid  fieldid   moonalt  moonillf   target_x   target_y  data_hasnan  pass  flag  cloudy\n11  5.746697   0.159835  328.996045  22.457548  3959.464750  623.91504  1.001469  ztf_20220701227072_000634_zr_c10_o.fits     30.0      38.0  ZTF_r  59761.227349     10       3   6.4      9.5      1.0  26.331351  1.808600e-06  0.022259  0.102724  0.000004 -0.000002  26.389000  26.394560  0.035455   0.518   0.615  0.268654    4    39   2.057    1.024      1711   21.34       1         0         2      634  -8.62992  0.040254  14.306084  14.948315        False     1  1024       0\n10  4.757964   0.132908  308.131321  18.120570  3723.431156  623.94850  1.001522  ztf_20220701275752_000634_zg_c10_o.fits     30.0      37.0  ZTF_g  59761.275752     10       3   6.4      9.5      1.0  26.331075  2.762400e-06  0.027478 -0.077798  0.000006 -0.000004  26.290001  26.283192  0.034550   0.518   0.615  0.269214    4    39   1.798    1.011      1702   21.77       1         0         1      634 -19.21150  0.042097  15.201741  15.291408        False     1  1024       0\n2   4.205405   0.070060  269.955607  17.207088  3569.281033  625.14480  1.003443  ztf_20220701297199_000634_zg_c10_o.fits     30.0      34.0  ZTF_g  59761.297211     10       3   6.4      9.5      1.0  26.320037  3.003400e-06  0.028764 -0.065447  0.000007 -0.000004  26.285999  26.279699  0.033778   0.519   0.616  0.270571    4    39   1.978    1.029      1705   21.72       1         0         1      634 -23.22300  0.042959  14.628763  15.244803        False     1  1024       0\n0   5.597245   0.154676  340.739486  20.210073  3926.535249  623.93677  1.001504  ztf_20220701343588_000634_zr_c10_o.fits     30.0      32.0  ZTF_r  59761.343588     10       3   6.4      9.5      1.0  26.331978  1.374600e-06  0.019357  0.094169  0.000003 -0.000002  26.386000  26.390105  0.031859   0.521   0.617  0.268707    4    39   1.678    1.122      1711   21.50       1         0         2      634 -29.95170  0.044759  14.729850  14.686664        False     1  1024       0\n4   4.990778   0.138341  338.700809  17.026911  3783.152848  623.95800  1.001538  ztf_20220701344525_000634_zr_c10_o.fits     30.0      32.0  ZTF_r  59761.344525     10       3   6.4      9.5      1.0  26.338354  1.645000e-06  0.021208  0.091538  0.000004 -0.000002  26.391001  26.394891  0.032522   0.521   0.618  0.269355    4    39   1.451    1.125      1711   21.62       1         0         2      634 -30.05570  0.044784  14.602233  14.700354        False     1  1024       0\n12  4.732350   0.064699  316.171740  19.694994  3716.785035  625.08540  1.003347  ztf_20220702212894_000634_zg_c10_o.fits     30.0      36.0  ZTF_g  59762.212905     10       3   6.4      9.5      1.0  26.327754  2.734600e-06  0.027393 -0.062361  0.000006 -0.000004  26.296000  26.289450  0.032122   0.518   0.614  0.269013    4    39   2.051    1.038      1705   21.57       1         0         1      634   1.55001  0.085393  14.577757  14.360933        False     1  1024       0\n13  5.513913   0.153567  325.433211  21.004261  3907.571023  623.69650  1.001118  ztf_20220702255197_000634_zr_c10_o.fits     30.0      34.0  ZTF_r  59762.255197     10       3   6.4      9.5      1.0  26.348572  1.477000e-06  0.020045  0.098956  0.000003 -0.000002  26.403999  26.409449  0.033240   0.518   0.615  0.267953    4    39   1.855    1.008      1706   21.44       1         0         2      634  -9.37129  0.087693  14.586978  14.724137        False     1  1024       0\n7   5.418287   0.150281  346.939376  20.585185  3885.890493  623.93964  1.001508  ztf_20220702277731_000634_zr_c10_o.fits     30.0      32.0  ZTF_r  59762.277743     10       3   6.4      9.5      1.0  26.346988  1.624900e-06  0.021038  0.098490  0.000004 -0.000002  26.402500  26.407545  0.033753   0.518   0.615  0.267995    4    39   1.812    1.014      1706   21.50       1         0         2      634 -14.78700  0.088940  15.285165  14.537979        False     1  1024       0\n1   5.538533   0.150691  243.819348  17.789335  3913.397259  623.98830  1.001586  ztf_20220702312894_000634_zi_c10_o.fits     30.0      29.0  ZTF_i  59762.312917     10       3   6.4      9.5      1.0  25.754435  8.170000e-07  0.021822  0.193169  0.000007 -0.000002  25.799999  25.809294  0.044885   0.208   0.284  0.203051    4    39   1.428    1.056      1723   21.15       1         0         3      634 -22.46710  0.090860  14.860625  14.403220        False     1  1024       0\n14  4.707948   0.133673  251.111087  20.017786  3710.255974  624.00560  1.001614  ztf_20220702319352_000634_zg_c10_o.fits     30.0      31.0  ZTF_g  59762.319352     10       3   6.4      9.5      1.0  26.344451  2.933000e-06  0.028282 -0.083678  0.000007 -0.000004  26.302000  26.293047  0.036127   0.518   0.614  0.268622    4    39   2.184    1.068      1699   21.53       1         0         1      634 -23.74910  0.091211  15.253905  14.354897        False     1  1024       0\n3   4.676175   0.130916  288.906350  18.588239  3701.761039  623.91600  1.001470  ztf_20220703213947_000634_zg_c10_o.fits     30.0       4.0  ZTF_g  59763.213958     10       3   6.4      9.5      1.0  26.338580  2.243100e-06  0.024752 -0.073653  0.000005 -0.000003  26.299000  26.293228  0.031724   0.519   0.616  0.269414    4    39   1.859    1.033      1700   21.63       1         0         1      634   7.82837  0.146821  14.653263  15.077677        False     1  1024       0\n5   6.387855   0.183527  348.765141  31.888637  4091.687604  623.92520  1.001485  ztf_20220703274375_000634_zr_c10_o.fits     30.0       4.0  ZTF_r  59763.274375     10       3   6.4      9.5      1.0  26.351234  2.365100e-06  0.025400  0.106896  0.000005 -0.000003  26.412001  26.417134  0.038356   0.520   0.616  0.268859    4    39   2.720    1.014      1707   20.85       1         0         2      634  -8.75614  0.150993  15.088851  14.994945        False     1  1024       0\n9   5.944982   0.165107  335.188177  22.093604  4001.757043  623.80493  1.001292  ztf_20220703299919_000634_zr_c10_o.fits     30.0       3.0  ZTF_r  59763.299919     10       3   6.4      9.5      1.0  26.348650  1.547200e-06  0.020561  0.098940  0.000003 -0.000002  26.403999  26.409539  0.033590   0.519   0.615  0.268468    4    39   1.770    1.039      1709   21.49       1         0         2      634 -15.29020  0.152833  14.764067  15.035494        False     1  1024       0\n6   5.625887   0.159495  361.966959  20.321409  3932.856748  623.85724  1.001376  ztf_20220703314167_000634_zr_c10_o.fits     30.0       4.0  ZTF_r  59763.314178     10       3   6.4      9.5      1.0  26.346978  1.557200e-06  0.020683  0.095798  0.000003 -0.000002  26.402000  26.406080  0.033027   0.521   0.617  0.268782    4    39   1.617    1.064      1722   21.65       1         0         2      634 -18.76610  0.153801  14.826469  14.648212        False     1  1024       0\n8   4.409479   0.041674  273.606610  18.113571  3628.457076  625.08940  1.003354  ztf_20220703360278_000634_zg_c10_o.fits     30.0       6.0  ZTF_g  59763.360289     10       3   6.4      9.5      1.0  26.314963  3.049800e-06  0.029042 -0.077785  0.000007 -0.000004  26.274000  26.267030  0.035849   0.518   0.616  0.270199    4    39   2.054    1.201      1715   21.65       1         0         1      634 -28.87460  0.157073  14.710053  15.172037        False     1  1024       0\n15  4.790281   0.139729  283.654818  21.116118  3731.876521  623.92240  1.001481  ztf_20220703362164_000634_zg_c10_o.fits     30.0       4.0  ZTF_g  59763.362176     10       3   6.4      9.5      1.0  26.311048  3.545000e-06  0.031340 -0.074763  0.000008 -0.000005  26.274000  26.265052  0.037288   0.518   0.615  0.270241    4    39   2.285    1.209      1713   21.46       1         0         1      634 -29.24300  0.157162  15.257037  15.214487        False     1  1024       0"

        df = pd.read_csv(df_filepath, comment="#")
        df.sort_values(by=["obsmjd"], inplace=True)
        self.assertEqual(df.to_string(), true_df_string)


if __name__ == "__main__":
    unittest.main()
